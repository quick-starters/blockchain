# Chapter 6. 블록체인에 거래를 기록하는 트랜잭션 이해하기

## Lesson 39. 트랜잭션의 역할과 내용

<u>블록체인의 기술적 관점</u>에서 `트랜잭션` 이라는 말이 나오면 보통 `거래` 를 의미한다. 예를 들어, '송금'하는 트랜잭션이라면 지갑 주소 하나에 있는 암호화폐를 다른 지갑 주소로 이동시킨다는 요청이 있으며, 해당 트랜잭션이 송신자의 것임을 증명하려고 만든 타임스탬프와 전자 서명이 포함되어 있다.

거래 내용, 타임스탬프, 전자 서명으로 이루어진 트랜잭션 파일의 해시값은 그 자체가 블록체인의 고유한 '트랜잭션 ID'이다.

![image-20211231170929710](images/image-20211231170929710.png)



거래 관련 트랜잭션은 보통 암호화폐를 보내는 사람과 받는 사람이 있다. 그런데 트랜젹션을 송금에만 사용하는 것은 아니다. 어떤 짧은 메시지를 기록하거나 문서의 존재를 증명하는 해시값을 기록할 때 '자신의 지갑에서 일부러 암호화폐를 꺼내 자신의 지갑에 거의 그대로 보낸다'는 특별한 트랜잭션을 만들 수도 있다. 이 기록 영역을 잘 이용하면 블록체인의 기능 자체를 확장할 수 있다.

![image-20211231181921327](images/image-20211231181921327.png)

>비트코인은 트랜잭션에 80바이트 정도의 짧은 메시지를 첨부할 수 있는 영역이 있다.



## Lesson 40.  지갑 주소의 미사용 잔액 'UTXO'

Lesson 35에서 보았던 것처럼 통상적인 지갑 앱은 많은 지갑 주소를 관리한다. 그리고 한 번 거래할 때마다 일회용이라는 느낌으로 주소를 생성한다. 그런데 지갑 앱은 많은 지갑 주소를 자동으로 관리하므로 사용자 대부분은 '어떤 지갑 주소에 암호화폐 잔액이 얼마 있다'는 자세한 정보를 알 필요가 없다.

지갑 앱이 나타내는 잔액은 지갑 앱이 괸리하는 많은 지갑 주소에 있는 미사용 잔액을 모두 합한 것이다. '자신이 사용할 수 있는 암호화폐의 한도'인 것이다. 그리고 이 미사용 잔액을 **UTXO(Unspent Transaction Output)**라고 한다.

블록체인은 `분산 원장 기술`의 구현이라고도 한다. UTXO가 원장에 해당하며 블록체인에 기록된 정보의 핵심 부분이기도 하다.



일정한 암호화폐 금액을 상대방에게 보낼 때는 자신이 소유한 UTXO 중 송금하는 데 충분한 잔액이 있는 UTXO를 INPUT에 배치한다. 그리고 상대의 지갑 주소로 송금하려는 암호화폐와 자신의 지갑 주소로 다시 되돌릴 잔액을 OUTPUT에 배치한다.

![image-20211231183748054](images/image-20211231183748054.png)

이때 거래 내용은 '송신자의 INPUT'과 '수신자의 OUTPUT' 합계가 항상 같아야한다. 이는 **복식부기 원장(=모든 거래 내용을 발생한 순서대로 기입하는 장부)을 기입(작성)하는 것과 같다.**

**트랜잭션은 반드시 UTXO, INPUT, OUTPUT의 균형을 항상 유지해야 한다**는 제약이 있다.

![image-20211231185142183](images/image-20211231185142183.png)



블록체인의 트랜잭션은 'UTXO >= INPUT = OUTPUT' 이라는 관계를 유지해야 한다고 했지만, 사실 비트코인의 트랜잭션 내용을 보면 'UTXO >= INPUT >= OUTPUT' 관계이다. **채굴자에게 수수료를 지급**할 암호화폐 금액을 빼기 때문이다. 수수료는 트랜잭션을 만드는 사람(송금자)이 자유롭게 정할 수 있다.

![image-20211231185407859](images/image-20211231185407859.png)



채굴자에게 지급하는 수수료(보상)를 자유롭게 설정할 수 있다면 수수료를 싸게 혹은 0으로 설정하는 것이 좋다고 생각할 수 있지만, 수수료가 너무 저렴하면 블록체인에 트랜잭션을 포함하지 못한다.

**'어떤 트랜잭션을 블록에 포함할 것인가?'는 채굴자가 자유롭게 정한다.** 즉, 채굴자에게 지급하는 수수료는 블록체인을 유지하는 데 필요한 보상이라는 면이 있다. 따라서 트랜잭션 풀에 트랜잭션이 많다면, 경제적 합리성을 고려해 수수료가 높은 것을 우선해서 블록에 포함한다. (수수료가 너무 싼 트랜잭션은 승인되지 않아 블록에 포함될 수 없다는 위험성이 있다.)

> 블록의 첫 기록(제네시스 블록)은 채굴자가 채굴에 성공했을 때 기록하는 'INPUT 없이 OUTPUT만 담긴 트랜잭션'이다.
>
> 비트코인의 제네시스 블록에는 OUTPUT에 50BTC가 담긴 트랜잭션 하나만 있다.



## Lesson 41. 트랜잭션을 합의하는 방법

트랜잭션은 P2P 분산 네트워크의 노드를 이용해 전 세계에 전달, 배포 및 복사된다. 먼저 사용자의 가장 가까운 노드에 트랜잭션을 배포한 후, 내용을 확인해 문제가 없으면 해당 트랜잭션을 복사한다. 이러한 **버킷 릴레이 방식으로 이웃 노드에 배포와 복사**를 반복해 전 세계에 전달한다. 일반적인 웹 서비스와 달리 특정 서버에 부하가 집중되지 않는다.

버킷 릴레이 방식으로 전 세계에 배포할 트랜잭션은 먼저 `트랜잭션 풀` 이나 `메모리 풀` 이라는 영역에 저장된다. 블록체인에 포함될 때까지 잠시 대기하는 상태이다.

트랜잭션이 트랜잭션 풀에 있으면 아직 블록체인이 트랜잭션을 포함한 것이 아니므로 해당 트랜잭션은 아직 '승인되지 않은 상태'이다. 블록체인에 트랜잭션이 포함되면 '승인된 상태'이자 해당 트랜잭션을 합의한 것이다.

![image-20211231200417097](images/image-20211231200417097.png)



생성한 트랜잭션을 트랜잭션 풀에 저장한 후 실제 **블록체인에 포함되기까지 적지 않은 시간 지연**이 있다.
