# Chapter 5. 지갑의 구조 이해하기

## Lesson 33. '지갑'은 암호화폐의 잔액을 확인하는 수단

암호화폐의 '지갑'에 대한 의미는 다음과 같다.

1. 모바일 앱과 웹 서비스로 '잔액 조회'나 '송금' 기능을 제공하는 인터페이스
2. **블록체인에서 사용하는 공개 키 암호화 빙식의 '비밀 키'와 '공개 키'를 바탕으로 수학적으로 도출한 '주소'**

책에서는 1의 개념을 '지갑 앱'이라고 하고, 암호 키를 바탕으로 알아낸 주소(식별자)인 2의 개념을 '지갑 주소'라고 한다.



지갑 주소는 실제 `비밀키 지갑 주소` 와 `공개키 지갑 주소` 로 구분한다. 암호화폐 거래 등에서 가장 흔히 보는 것은 '공개키 지갑 주소'로, '암호화폐를 받는 주소' 혹은 '암호화폐를 보낼 주소'이다. 비밀 키 지갑 주소는 거래에 서명하는 지갑 주소이다.

실제 지갑 앱 안에는 보통 비밀 키를 보관하는 편이므로 비밀 키 지갑 주소는 암호화폐 지갑을 백엽하는 역할로 볼 수 있다. 그래서 'WIF(Wallet Import Format)'라고도 한다. 비밀키 지갑 주소는 다른 지갑 앱에 주소를 마이그레이션하는 용도로 사용한다.

![image-20211226210205596](images/image-20211226210205596.png)

- 난수열에서 비밀키를 생성한다.
- 비밀키는 백업에 필요한 WIF 형식으로 내보낼 수 있다.
- 공개키에서 비밀키를 알아낼 수 없다.
- 공개키로 지갑 주소를 만들더라도 지갑 주소로 공개키를 알아낼 수 없다.



## Lesson 34. 지갑 주소를 알아내는 방법

비밀키와 공개키를 기반에 두는 지갑 주소는 모두 특정 연산으로 만든다. 사용자는 이 연산 자체의 원리를 신경 쓸 필요는 없다. 지갑 앱을 처음 설치할 때 자동으로 만들기 때문이다.

특정 연산은 인터넷과 연결할 필요 없이 수행된다는 특징이 있다. **기존 온라인 서비스처럼 회원가입, 로그인, 데이터베이스에 개인 정보 등록 등을 할 필요가 없는 것이다.** 지갑 앱은 설치 후 바로 지갑 주소가 만들어져 암호화폐를 보내고 받거나 지갑 앱에 있는 암호화폐 잔액을 확인할 수 있다.

![image-20211226210805090](images/image-20211226210805090.png)



비트코인 주소를 예로 들어 지갑 주소의 구조를 살펴보자. 비트코인 지갑 주소는 1로 시작하는 27~34자리의 알파벳과 숫자로 구성되어 있으며, 각각 `헤더(Header), 개체(Entity), 체크섬(Checksum)` 블록으로 구분한다.

![image-20211226211135900](images/image-20211226211135900.png)

지갑 주소에 사용하는 숫자는 Base58이라는 이진 텍스트 인코딩 방식으로 만든다. 지갑 주소는 다음과 같은 순서로 작성된다.

![image-20211226211441226](images/image-20211226211441226.png)

> 지갑 주소는 왜 Base64가 아닌 Base58을 사용할까? Base58은 0과 O, I와 l등 헷갈리기 쉬운 문자와 /(슬래시)나 +(플러스) 같은 기호를 사용하지 않고 이진 정보를 텍스트 형태로 나타내는 구조이다. 즉, 사람이 직접 인코딩한 문자를 적어 정보를 교환하기 쉽다.



비트코인에는 공개키는 160비트로 이루어져있어, 사실상 무한하다고 볼 수 있다.

![image-20211226211725742](images/image-20211226211725742.png)

또한, 지갑 주소 패턴 160비트에 2의96승을 추가한 256비트 난수를 바탕으로 만들기 때문에, 지갑 주소의 충돌은 걱정하지 않아도 된다.



1로 시작하는 비트코인 표준 공개키 지갑 주소 이외에도 **헤더 부분에 고윳값이 있는 주소 유형이 몇 가지가 있다.**



## Lesson 35. 거래의 창구 역할을 하는 지갑 앱

블록체인은 트랜잭션 데이터를 쌓지만, 잔액 조회 서비스나 송금 기능 등은 제공하지 않는다. 잔액 합계와 트랜잭션 생성, 전자 서명, 네트워크 배포 같은 작업은 지갑 앱에서 이루어진다.

**지갑 앱은 지갑 주소를 관리하고, 잔액을 조회하고, 송금하는 등 거래에 필요한 기능을 제공하는 도구이다.**

![image-20211226212748694](images/image-20211226212748694.png)

추가로 트랜잭션에 사용하는 암호키 쌍의 생성과 보관, 블록체인이 정한 형식으로 트랜잭션을 생성한 후 신뢰성을 향상하는 전자 서명, 블록체인 P2P 네트워크에 연결해 트랜잭션을 배포하는 등의 작업도 담당한다.



블록체인은 사용자별 잔액을 관리하는 데이터 구조가 아니다. 사용자 개념조차 없다. **사실 지갑 앱은 블록체인을 검색해 자신의 지갑 주소와 관련된 트랜잭션 데이터를 읽고 미사용 잔액을 계산한다.** 겉보기에는 아날로그적이고 시간이 걸리는 작업이므로 효율이 높지 않다고 생각할 수 있다. 하지만, 검색 성능이 좋은 트리 구조의 데이터 형식, 자신의 자신의 주소 관련 정보를 효율적으로 불러오는 블룸 필터(Bloom Filter)라는 탐색 알고리즘 등을 이용해 잔액을 빠르게 계산할 수 있다.



지갑 주소 사이에 거래가 성립하려면 어떤 주소에서 어떤 주소로 송금할 것인지 명확히 할 필요가 있다. 따라서 지갑 주소는 당연히 고유한 ID 같은 것이어야 한다. 최근에는 지갑 앱 하나에 많은 지갑 주소를 할당하는 것이 일반적이다.

**블록체인의 트랜잭션 기록은 원칙적으로 언제든지 누구나 볼 수 있는 상태이다.** 주소 하나만으로 여러 번 거래하면 해당 주소는 누구와 거래하는지는 몰라도 자주 거래함을 분명히 알 것이다. 지갑 내용을 훔치려는 사람의 표적이 될 확률이 높다.

많은 지갑 주소를 관리하는 앱은 새로운 거래마다 새로운 지갑 주소를 만들기 때문에 수백, 수천, 수만 같은 개수의 주소가 있다. 지갑 앱이 자동으로 주소를 만들어 주므로 사용자는 신경 쓸 필요가 없다. 그렇다고 하더라도 많은 지갑 주소를 관리하는 것은 어려운 일이 아닌가 하는 생각도 들 수 있다. 지갑 주소를 관리할 때 겪는 일반적인 어려움은 다음 두 가지이다.

1. 키가 너무 많으면 유출당할 위험도 높아지는 것 아닐까?
2. 키를 분실할 위험에 대비해 백업하고 싶은데 어떻게 해야 할까?

Lesson 36에서 더 알아본다.